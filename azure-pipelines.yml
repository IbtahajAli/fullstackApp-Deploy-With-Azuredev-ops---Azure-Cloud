trigger:
- main

pool:
  name: local-pool # Using your self-hosted agent for all stages

variables:
  # --- TERRAFORM VARIABLES ---
  tfVersion: '1.9.0'
  workingDir: '$(System.DefaultWorkingDirectory)/terraform'
  bkResourceGroup: 'rg-terraform-backend'
  bkStorageAccount: 'tfstatedevopsapp123'
  bkContainer: 'tfstate'
  bkLocation: 'eastus'
  
  # --- APP & DEPLOY VARIABLES ---
  # Based on your Terraform main.tf
  acrLoginServer: 'devopsacr123.azurecr.io' 
  
  # Service Connection Names (Created in ADO Project Settings)
  acrServiceConnection: 'acr-connection'            # Select Docker Registry -> Azure Container Registry
  aksServiceConnection: 'aks-connection'            # Select Kubernetes -> Azure Subscription
  sonarServiceConnection: 'sonarqube-local-connection' # The one we just named above
  
  # Image Config
  backendImageName: 'backend-app'
  frontendImageName: 'frontend-app'
  tag: '$(Build.BuildId)'

stages:
# ----------------------------
# STAGE 1: INFRASTRUCTURE (Terraform)
# ----------------------------
- stage: Terraform
  displayName: "Infrastructure"
  jobs:
  - job: DeployInfra
    displayName: "Terraform Apply"
    steps:
    - task: TerraformInstaller@0
      displayName: "Install Terraform"
      inputs:
        terraformVersion: $(tfVersion)

    - task: AzureCLI@2
      displayName: "Check & Create Backend Storage"
      inputs:
        azureSubscription: 'azure-rm-terraform'
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        inlineScript: |
          $rgExists = az group exists --name $(bkResourceGroup)
          if ($rgExists -eq "false") { az group create --name $(bkResourceGroup) --location $(bkLocation) }
          
          $accExists = az storage account check-name --name $(bkStorageAccount) | ConvertFrom-Json
          if ($accExists.nameAvailable -eq $true) { az storage account create --name $(bkStorageAccount) --resource-group $(bkResourceGroup) --location $(bkLocation) --sku Standard_LRS }
          
          $key = az storage account keys list --resource-group $(bkResourceGroup) --account-name $(bkStorageAccount) --query "[0].value" -o tsv
          
          $containerCheck = az storage container exists --name $(bkContainer) --account-name $(bkStorageAccount) --account-key $key | ConvertFrom-Json
          if ($containerCheck.exists -eq "false") { az storage container create --name $(bkContainer) --account-name $(bkStorageAccount) --account-key $key }
          
          Write-Host "##vso[task.setvariable variable=ARM_ACCESS_KEY;issecret=true]$key"

    - task: AzureCLI@2
      displayName: "Terraform Init"
      inputs:
        azureSubscription: 'azure-rm-terraform'
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        workingDirectory: $(workingDir)
        inlineScript: terraform init -input=false -reconfigure
      env:
        ARM_ACCESS_KEY: $(ARM_ACCESS_KEY)

    - task: AzureCLI@2
      displayName: "Terraform Plan"
      inputs:
        azureSubscription: 'azure-rm-terraform'
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        workingDirectory: $(workingDir)
        inlineScript: terraform plan -out=tfplan -var "sql_password=$env:SQL_PASS"
      env:
        SQL_PASS: $(sql_password)
        ARM_ACCESS_KEY: $(ARM_ACCESS_KEY)

    - task: AzureCLI@2
      displayName: "Terraform Apply"
      inputs:
        azureSubscription: 'azure-rm-terraform'
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        workingDirectory: $(workingDir)
        inlineScript: terraform apply -auto-approve tfplan
      env:
        ARM_ACCESS_KEY: $(ARM_ACCESS_KEY)

# ----------------------------
# STAGE 2: CODE QUALITY (SonarQube)
# ----------------------------
- stage: CodeQuality
  displayName: "SonarQube Scan"
  dependsOn: Terraform
  condition: succeeded()
  jobs:
  - job: SonarScan
    displayName: "Analyze Code"
    steps:
    - task: SonarQubePrepare@5
      inputs:
        SonarQube: '$(sonarServiceConnection)'
        scannerMode: 'CLI'
        configMode: 'manual'
        cliProjectKey: 'my-devops-app' # Set this key in your SonarQube UI
        cliProjectName: 'My DevOps App'
        extraProperties: |
          sonar.sources=frontend,backend
          sonar.exclusions=**/node_modules/**,**/build/**,**/dist/**

    - task: SonarQubeAnalyze@5
      displayName: "Run Code Analysis"

    - task: SonarQubePublish@5
      displayName: "Publish Quality Gate"
      inputs:
        pollingTimeoutSec: '300'

# ----------------------------
# STAGE 3: BUILD & PUSH (Docker)
# ----------------------------
- stage: BuildAndPush
  displayName: "Build Docker Images"
  dependsOn: CodeQuality
  condition: succeeded()
  jobs:
  - job: BuildImages
    displayName: "Build & Push"
    steps:
    - task: Docker@2
      displayName: "Build Backend"
      inputs:
        command: buildAndPush
        repository: $(backendImageName)
        dockerfile: 'backend/Dockerfile'
        containerRegistry: $(acrServiceConnection)
        tags: |
          $(tag)
          latest

    - task: Docker@2
      displayName: "Build Frontend"
      inputs:
        command: buildAndPush
        repository: $(frontendImageName)
        dockerfile: 'frontend/Dockerfile'
        containerRegistry: $(acrServiceConnection)
        tags: |
          $(tag)
          latest

# ----------------------------
# STAGE 4: DEPLOY (AKS)
# ----------------------------
- stage: Deploy
  displayName: "Deploy to AKS"
  dependsOn: BuildAndPush
  condition: succeeded()
  jobs:
  - deployment: DeployAKS
    displayName: "Deploy Manifests"
    environment: 'production'
    strategy:
      runOnce:
        deploy:
          steps:
            - task: KubernetesManifest@0
              displayName: "Apply Manifests"
              inputs:
                action: 'deploy'
                kubernetesServiceConnection: $(aksServiceConnection)
                namespace: 'default'
                manifests: |
                  $(System.DefaultWorkingDirectory)/manifests/deployment.yml
                  $(System.DefaultWorkingDirectory)/manifests/service.yml
                containers: |
                  $(acrLoginServer)/$(backendImageName):$(tag)
                  $(acrLoginServer)/$(frontendImageName):$(tag)