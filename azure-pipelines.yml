trigger:
- main

pool:
  name: local-pool

variables:
  # --- TERRAFORM VARS ---
  tfVersion: '1.9.0'
  workingDir: '$(System.DefaultWorkingDirectory)/terraform'
  bkResourceGroup: 'rg-terraform-backend'
  bkStorageAccount: 'tfstatedevopsapp123'
  bkContainer: 'tfstate'
  bkLocation: 'eastus'
  
  # --- CONNECTIONS ---
  acrLoginServer: 'devopsacr123.azurecr.io' 
  acrServiceConnection: 'acr-connection'    
  aksServiceConnection: 'aks-connection'            
  
  # --- IMAGES ---
  backendImageName: 'backend-app'
  frontendImageName: 'frontend-app'
  tag: '$(Build.BuildId)'
  
  # --- APP CONFIG ---
  # RUN 1: Keep as localhost. 
  # RUN 2: Update this after getting the Public IP from Azure Portal.
  backendUrl: 'http://localhost:5000' 

stages:
# ----------------------------
# STAGE 1: INFRASTRUCTURE
# ----------------------------
- stage: Terraform
  displayName: "Infrastructure Check"
  jobs:
  - job: TerraformApply
    steps:
    - task: TerraformInstaller@0
      inputs:
        terraformVersion: $(tfVersion)

    - task: AzureCLI@2
      displayName: "Init & Apply Terraform"
      inputs:
        azureSubscription: 'azure-rm-terraform'
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        workingDirectory: $(workingDir)
        inlineScript: |
          # 1. Fetch Key
          $key = az storage account keys list --resource-group $(bkResourceGroup) --account-name $(bkStorageAccount) --query "[0].value" -o tsv
          
          # 2. Set Env Var for THIS session (Fixes the base64 error)
          $env:ARM_ACCESS_KEY = $key
          
          # 3. Run Terraform
          terraform init -input=false -reconfigure
          terraform apply -auto-approve -var "sql_password=$env:SQL_PASS"
      env:
        SQL_PASS: $(sql_password)

# ----------------------------
# STAGE 2: CODE QUALITY (SKIPPED FOR NOW)
# ----------------------------
# - stage: CodeQuality
#   displayName: "SonarQube Scan"
#   dependsOn: Terraform
#   jobs:
#   - job: SonarScan
#     steps:
#     - task: SonarQubePrepare@5
#       inputs:
#         SonarQube: 'sonarqube-local-connection'
#         scannerMode: 'CLI'
#         configMode: 'manual'
#         cliProjectKey: 'my-devops-app'
#         cliProjectName: 'My DevOps App'
#     - task: SonarQubeAnalyze@5
#     - task: SonarQubePublish@5
#       inputs:
#         pollingTimeoutSec: '300'

# ----------------------------
# STAGE 3: BUILD & PUSH
# ----------------------------
- stage: BuildAndPush
  displayName: "Build Docker Images"
  dependsOn: Terraform
  jobs:
  - job: BuildImages
    steps:
    - task: Docker@2
      displayName: "Build Backend"
      inputs:
        command: buildAndPush
        repository: $(backendImageName)
        dockerfile: 'backend/Dockerfile'
        containerRegistry: $(acrServiceConnection)
        tags: |
          $(tag)
          latest

    - task: Docker@2
      displayName: "Build Frontend"
      inputs:
        command: buildAndPush
        repository: $(frontendImageName)
        dockerfile: 'frontend/Dockerfile'
        containerRegistry: $(acrServiceConnection)
        arguments: '--build-arg REACT_APP_API_URL=$(backendUrl)'
        tags: |
          $(tag)
          latest

# ----------------------------
# STAGE 4: DEPLOY
# ----------------------------
- stage: Deploy
  displayName: "Deploy to AKS"
  dependsOn: BuildAndPush
  jobs:
  - deployment: DeployAKS
    environment: 'production'
    strategy:
      runOnce:
        deploy:
          steps:
            # 1. CREATE DATABASE SECRET IN KUBERNETES
            # This takes the secure variable from ADO and creates a secret named 'db-secret'
            - task: Kubernetes@1
              displayName: "Create DB Secret"
              inputs:
                connectionType: 'Kubernetes Service Connection'
                kubernetesServiceEndpoint: $(aksServiceConnection)
                command: 'login' # Login isn't strictly needed for the next inline script but ensures connectivity
            
            - task: AzureCLI@2
              displayName: "Set K8s Secret"
              inputs:
                azureSubscription: 'azure-rm-terraform'
                scriptType: 'ps'
                scriptLocation: 'inlineScript'
                inlineScript: |
                  az aks get-credentials --resource-group devops-rg --name devops-aks --overwrite-existing
                  # Create secret if not exists, or update it
                  kubectl create secret generic db-secret --from-literal=password=$(sql_password) --dry-run=client -o yaml | kubectl apply -f -

            # 2. DEPLOY MANIFESTS
            - task: KubernetesManifest@0
              displayName: "Apply Manifests"
              inputs:
                action: 'deploy'
                kubernetesServiceConnection: $(aksServiceConnection)
                namespace: 'default'
                manifests: |
                  $(System.DefaultWorkingDirectory)/manifests/deployment.yml
                  $(System.DefaultWorkingDirectory)/manifests/service.yml
                containers: |
                  $(acrLoginServer)/$(backendImageName):$(tag)
                  $(acrLoginServer)/$(frontendImageName):$(tag)