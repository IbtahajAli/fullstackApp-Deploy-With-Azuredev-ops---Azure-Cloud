trigger:
- main

pool:
  name: local-pool

variables:
  tfVersion: '1.9.0'
  workingDir: '$(System.DefaultWorkingDirectory)/terraform'
  # BACKEND CONFIG (Must match provider.tf)
  bkResourceGroup: 'rg-terraform-backend'
  bkStorageAccount: 'tfstatedevopsapp123' # Ensure this is unique
  bkContainer: 'tfstate'
  bkLocation: 'eastus'

stages:
- stage: Terraform
  jobs:
  - job: DeployInfra
    displayName: "Terraform Infrastructure Deployment"
    steps:
    
    # Step 1: Install Terraform
    - task: TerraformInstaller@0
      displayName: "Install Terraform"
      inputs:
        terraformVersion: $(tfVersion)

    # Step 2: Smart Bootstrap (Safe for Re-runs)
    - task: AzureCLI@2
      displayName: "Check & Create Backend Storage"
      inputs:
        azureSubscription: 'azure-rm-terraform'
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        inlineScript: |
          # 1. Create Resource Group if missing
          $rgExists = az group exists --name $(bkResourceGroup)
          if ($rgExists -eq "false") {
            Write-Host "Creating Resource Group: $(bkResourceGroup)"
            az group create --name $(bkResourceGroup) --location $(bkLocation)
          } else {
            Write-Host "Resource Group $(bkResourceGroup) already exists."
          }

          # 2. Create Storage Account if missing
          $accExists = az storage account check-name --name $(bkStorageAccount) | ConvertFrom-Json
          if ($accExists.nameAvailable -eq $true) {
             Write-Host "Creating Storage Account: $(bkStorageAccount)"
             az storage account create --name $(bkStorageAccount) --resource-group $(bkResourceGroup) --location $(bkLocation) --sku Standard_LRS
          } else {
             Write-Host "Storage Account $(bkStorageAccount) already exists."
          }

          # 3. Get Key
          $key = az storage account keys list --resource-group $(bkResourceGroup) --account-name $(bkStorageAccount) --query "[0].value" -o tsv
          
          # 4. Create Container if missing
          $containerCheck = az storage container exists --name $(bkContainer) --account-name $(bkStorageAccount) --account-key $key | ConvertFrom-Json
          if ($containerCheck.exists -eq "false") {
             Write-Host "Creating Container: $(bkContainer)"
             az storage container create --name $(bkContainer) --account-name $(bkStorageAccount) --account-key $key
          } else {
             Write-Host "Container $(bkContainer) already exists."
          }

          # 5. Pass Key to Next Steps
          Write-Host "##vso[task.setvariable variable=ARM_ACCESS_KEY;issecret=true]$key"

    # Step 3: Terraform Init
    - task: AzureCLI@2
      displayName: "Terraform Init"
      inputs:
        azureSubscription: 'azure-rm-terraform'
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        workingDirectory: $(workingDir)
        inlineScript: |
          terraform init -input=false -reconfigure
      env:
        ARM_ACCESS_KEY: $(ARM_ACCESS_KEY)

    # Step 4: Terraform Plan
    - task: AzureCLI@2
      displayName: "Terraform Plan"
      inputs:
        azureSubscription: 'azure-rm-terraform'
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        workingDirectory: $(workingDir)
        inlineScript: |
          terraform plan -out=tfplan -var "sql_password=$env:SQL_PASS"
      env:
        SQL_PASS: $(sql_password)
        ARM_ACCESS_KEY: $(ARM_ACCESS_KEY)

    # Step 5: Terraform Apply
    - task: AzureCLI@2
      displayName: "Terraform Apply"
      inputs:
        azureSubscription: 'azure-rm-terraform'
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        workingDirectory: $(workingDir)
        inlineScript: |
          terraform apply -auto-approve tfplan
      env:
        ARM_ACCESS_KEY: $(ARM_ACCESS_KEY)