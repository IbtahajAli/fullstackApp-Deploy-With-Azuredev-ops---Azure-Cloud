trigger:
- main

pool:
  name: local-pool   # your self-hosted agent pool

variables:
  tfVersion: '1.9.0'
  workingDir: '$(System.DefaultWorkingDirectory)/terraform'

stages:
- stage: Terraform
  jobs:
  - job: DeployInfra
    displayName: "Terraform Infrastructure Deployment"
    steps:
    # Install Terraform
    - task: TerraformInstaller@0
      displayName: "Install Terraform"
      inputs:
        terraformVersion: $(tfVersion)

    # Run Terraform commands with Azure authentication
    - task: AzureCLI@2
      displayName: "Terraform Init/Validate/Plan/Apply"
      inputs:
        azureSubscription: 'azure-rm-terraform'   # Azure Resource Manager service connection
        scriptType: 'ps'                          # Use PowerShell on Windows agent
        scriptLocation: 'inlineScript'
        workingDirectory: $(workingDir)
        inlineScript: |
          Write-Host "Initializing Terraform..."
          terraform init -input=false

          Write-Host "Formatting & validating..."
          terraform fmt -check
          terraform validate

          Write-Host "Planning infrastructure..."
          terraform plan -out=tfplan -var "sql_password=$(sql_password)"

          Write-Host "Applying infrastructure..."
          terraform apply -auto-approve tfplan