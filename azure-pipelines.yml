trigger:
- main

pool:
  name: local-pool   # your self-hosted agent pool

variables:
  tfVersion: '1.9.0'
  workingDir: '$(System.DefaultWorkingDirectory)/terraform'

stages:
- stage: Terraform
  jobs:
  - job: DeployInfra
    displayName: "Terraform Infrastructure Deployment"
    steps:
    - task: TerraformInstaller@0
      displayName: "Install Terraform"
      inputs:
        terraformVersion: $(tfVersion)

    # Step 1: Init (backend requires ARM_* env vars)
    - task: AzureCLI@2
      displayName: "Terraform Init"
      inputs:
        azureSubscription: 'azure-rm-terraform'
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        workingDirectory: $(workingDir)
        inlineScript: |
          Write-Host "Initializing Terraform with reconfigure..."
          terraform init -input=false -reconfigure
      env:
        ARM_SUBSCRIPTION_ID: $(subscription_id)
        ARM_TENANT_ID: $(tenant_id)
        ARM_CLIENT_ID: $(client_id)
        ARM_CLIENT_SECRET: $(client_secret)

    # Step 2: Plan
    - task: AzureCLI@2
      displayName: "Terraform Plan"
      inputs:
        azureSubscription: 'azure-rm-terraform'
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        workingDirectory: $(workingDir)
        inlineScript: |
          Write-Host "Formatting & validating..."
          terraform fmt -check
          terraform validate

          Write-Host "Planning infrastructure..."
          terraform plan -out=tfplan `
            -var "sql_password=$env:sql_password" `
            -var "subscription_id=$env:subscription_id" `
            -var "client_id=$env:client_id" `
            -var "client_secret=$env:client_secret" `
            -var "tenant_id=$env:tenant_id"
      env:
        ARM_SUBSCRIPTION_ID: $(subscription_id)
        ARM_TENANT_ID: $(tenant_id)
        ARM_CLIENT_ID: $(client_id)
        ARM_CLIENT_SECRET: $(client_secret)

    # Step 3: Apply
    - task: AzureCLI@2
      displayName: "Terraform Apply"
      inputs:
        azureSubscription: 'azure-rm-terraform'
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        workingDirectory: $(workingDir)
        inlineScript: |
          Write-Host "Applying infrastructure..."
          terraform apply -auto-approve tfplan
      env:
        ARM_SUBSCRIPTION_ID: $(subscription_id)
        ARM_TENANT_ID: $(tenant_id)
        ARM_CLIENT_ID: $(client_id)
        ARM_CLIENT_SECRET: $(client_secret)